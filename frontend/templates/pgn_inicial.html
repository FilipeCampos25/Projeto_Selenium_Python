<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Sistema de Coleta PGC/PNCP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
        /* Reset leve e base */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f4f9ff 0%, #ffffff 100%);
      padding: 2rem;
      max-width: 900px;
      margin: auto;
      color: #1f2937;
    }

    /* T√≠tulo */
    h1 {
      font-size: 1.9rem;
      font-weight: 700;
      color: #1e3a8a;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    h3 {
      text-align: center;
      color: #02246d;
    }

    /* Texto descritivo */
    p {
      color: #374151;
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }

    /* Bot√µes */
    button {
      font-size: 1rem;
      font-weight: 600;
      padding: 0.75rem 1rem;
      margin-top: 0.75rem;
      width: 100%;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
      transition: all 0.25s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.35);
    }

    button:disabled {
      background: #93c5fd;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* √Årea de status / log */
    .log {
      white-space: pre-wrap;
      background: #f8fafc;
      padding: 1rem 1.2rem;
      border-radius: 12px;
      margin-top: 1.2rem;
      max-height: 40vh;
      overflow: auto;
      font-size: 0.95rem;
      color: #1f2937;
      border: 1px solid #e2e8f0;
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.05);
    }

    /* Link do VNC */
    .vnc-link {
      display: inline-block;
      margin-top: 0.8rem;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #ffffff;
      padding: 0.6rem 1rem;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
      box-shadow: 0 6px 16px rgba(34, 197, 94, 0.3);
      transition: all 0.25s ease;
    }

    .vnc-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(34, 197, 94, 0.4);
    }

    /* Scroll do log mais elegante */
    .log::-webkit-scrollbar {
      width: 8px;
    }

    .log::-webkit-scrollbar-track {
      background: transparent;
    }

    .log::-webkit-scrollbar-thumb {
      background-color: #c7d2fe;
      border-radius: 4px;
    }

    .log::-webkit-scrollbar-thumb:hover {
      background-color: #a5b4fc;
    }

  </style>
</head>
<body>
  <h1> Sistema de Coleta PGC/PNCP</h1>
  <p>O navegador ser√° aberto automaticamente. Ap√≥s clicar em "Iniciar Coleta", abra o VNC para fazer o login manual.</p>

  <div id="coletaSection">
    <h3> Coleta Unificada (PGC ‚Üí PNCP)</h3>
    <p>Esta a√ß√£o iniciar√° a coleta do PGC e, automaticamente ap√≥s o t√©rmino, iniciar√° a coleta do PNCP.</p>
    <button id="btnIniciarColeta"> Iniciar Coleta</button>
  </div>

  <div id="status" class="log">Nenhuma a√ß√£o ainda.</div>
  
  <!-- ============================================================
       üî¥ IN√çCIO MODIFICA√á√ÉO LOCAL - REMOVER QUANDO VOLTAR DOCKER
       ============================================================ -->
  <!-- VNC link (somente em modo Docker) -->
  <a
    id="vncLink"
    class="vnc-link" 
    href="http://localhost:7900" 
    target="_blank" 
    style="display:none;">üñ•Ô∏è Abrir VNC (ver navegador)
  </a>
  
  <!-- Aviso de modo local -->
  <div id="modoLocalAviso" style="display:none; margin-top: 20px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
    <strong>‚ö†Ô∏è Modo LOCAL ativo:</strong> O navegador abrir√° em sua m√°quina. Fa√ßa login quando solicitado.
  </div>
  <!-- ============================================================
       üî¥ FIM MODIFICA√á√ÉO LOCAL
       ============================================================ -->

  <script>
    const btnIniciarColeta = document.getElementById('btnIniciarColeta');
    const status = document.getElementById('status');
    const vncLink = document.getElementById('vncLink');
    
    // ============================================================
    // üî¥ IN√çCIO MODIFICA√á√ÉO LOCAL - REMOVER QUANDO VOLTAR DOCKER
    // ============================================================
    // Detectar modo local verificando se a API retorna informa√ß√£o de modo
    let modoLocal = false;
    
    // Tentar determinar modo a partir de resposta da API
    fetch('/api/ready')
      .then(r => r.json())
      .then(data => {
        if (data.mode === 'local') {
          modoLocal = true;
          document.getElementById('modoLocalAviso').style.display = 'block';
        }
      })
      .catch(() => {
        // Se falhar, assumir Docker (padr√£o)
      });
    // ============================================================
    // üî¥ FIM MODIFICA√á√ÉO LOCAL
    // ============================================================

    btnIniciarColeta.addEventListener('click', async () => {
      const ano = prompt("Por favor, insira o Ano de Refer√™ncia (ex: 2025):");
      if (!ano || ano.trim() === "") {
        alert('O Ano de Refer√™ncia √© obrigat√≥rio.');
        return;
      }
      const ano_ref = parseInt(ano.trim());
      if (isNaN(ano_ref) || ano_ref < 2000 || ano_ref > 2100) {
        alert('Ano de Refer√™ncia inv√°lido.');
        return;
      }

      btnIniciarColeta.disabled = true;
      
      // ============================================================
      // üî¥ IN√çCIO MODIFICA√á√ÉO LOCAL - REMOVER QUANDO VOLTAR DOCKER
      // ============================================================
      // Mensagem diferente para modo local vs Docker
      const mensagemInicial = modoLocal 
        ? 'Iniciando sequ√™ncia de coleta (PGC -> PNCP)... O navegador abrir√° em sua m√°quina.' 
        : 'Iniciando sequ√™ncia de coleta (PGC -> PNCP)... Abra o VNC para fazer login manual.';
      status.textContent = mensagemInicial;
      // ============================================================
      // üî¥ FIM MODIFICA√á√ÉO LOCAL
      // ============================================================

      try {
        const resp = await fetch('/api/coleta/iniciar', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ ano_ref: ano_ref })
        });
        const data = await resp.json();
        
        if (!resp.ok) {
          status.textContent = 'Erro ao iniciar coleta: ' + (data.detail || JSON.stringify(data));
          btnIniciarColeta.disabled = false;
          return;
        }
        
        // ============================================================
        // üî¥ IN√çCIO MODIFICA√á√ÉO LOCAL - REMOVER QUANDO VOLTAR DOCKER
        // ============================================================
        // N√£o abrir noVNC em modo local
        status.textContent = data.message || 'Sequ√™ncia de coleta iniciada. Fa√ßa login quando solicitado.';
        
        if (!modoLocal) {
          // Apenas em modo Docker: mostrar VNC e abrir automaticamente
          vncLink.style.display = 'inline-block';
          setTimeout(() => {
            window.open('http://localhost:7900', '_blank');
          }, 1500);
        }
        // ============================================================
        // üî¥ FIM MODIFICA√á√ÉO LOCAL
        // ============================================================


        // O bot√£o permanece desabilitado para evitar disparos m√∫ltiplos durante a execu√ß√£o em background
        // Em um sistema real, poder√≠amos ter um polling de status mais robusto aqui
        
      } catch (err) {
        status.textContent = 'Erro na conex√£o: ' + err.message;
        btnIniciarColeta.disabled = false;
      }
    });
  </script>
</body>
</html>
